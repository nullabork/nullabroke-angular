<div hlmSidebarWrapper class="h-screen" [sidebarWidth]="'16rem'" [sidebarWidthIcon]="'3.5rem'">
  <!-- Sidebar -->
  <hlm-sidebar collapsible="icon" class="bg-[#252526] border-r border-[#3c3c3c]">
    <div hlmSidebarContent class="bg-[#252526]">
      <!-- Queries Header (sticky) -->
      <div class="flex-none flex items-center justify-between px-2 py-1.5 border-b border-[#3c3c3c] bg-[#252526] group-data-[collapsible=icon]:justify-center">
        <span class="text-[11px] text-[#858585] uppercase tracking-wide group-data-[collapsible=icon]:hidden">Queries</span>
        <button
          [hlmDropdownMenuTrigger]="queriesMenu"
          class="w-5 h-5 flex items-center justify-center text-[#555555] hover:text-[#cccccc] hover:bg-[#3c3c3c] rounded transition-colors"
          title="Query actions"
        >
          <ng-icon name="lucideEllipsisVertical" class="text-[14px]" />
        </button>
        <ng-template #queriesMenu>
          <hlm-dropdown-menu class="w-52 bg-[#252526] border-[#3c3c3c]">
            <hlm-dropdown-menu-group>
              <button hlmDropdownMenuItem (click)="newQuery()" class="text-[#cccccc] hover:bg-[#3c3c3c] focus:bg-[#3c3c3c]">
                <ng-icon name="lucidePlus" class="mr-2" /> New Query
              </button>
            </hlm-dropdown-menu-group>
            <hlm-dropdown-menu-separator class="bg-[#3c3c3c]" />
            <hlm-dropdown-menu-group>
              @if (hasDeletedBlueprints()) {
                <button hlmDropdownMenuItem (click)="restoreDefaults()" class="text-[#cccccc] hover:bg-[#3c3c3c] focus:bg-[#3c3c3c]">
                  <ng-icon name="lucideRotateCcw" class="mr-2" /> Restore Defaults
                </button>
              }
              <button hlmDropdownMenuItem (click)="resetAllQueries()" class="text-[#cccccc] hover:bg-[#3c3c3c] focus:bg-[#3c3c3c]">
                <ng-icon name="lucideRotateCcw" class="mr-2" /> Reset Queries
              </button>
              <button hlmDropdownMenuItem (click)="deleteAllDefaults()" class="text-[#f48771] hover:bg-[#5a1d1d] focus:bg-[#5a1d1d]">
                <ng-icon name="lucideTrash2" class="mr-2" /> Delete All Defaults
              </button>
            </hlm-dropdown-menu-group>
          </hlm-dropdown-menu>
        </ng-template>
      </div>

      <!-- Queries List (scrollable) -->
      <div hlmSidebarGroup class="flex-1 overflow-y-auto">
        <div hlmSidebarGroupContent>
          <ul hlmSidebarMenu>
            <!-- Loading Skeletons -->
            @if (queriesLoading()) {
              @for (item of skeletonItems; track item) {
                <li hlmSidebarMenuItem>
                  <div class="flex items-center gap-2 px-2 py-1.5">
                    <hlm-skeleton class="w-8 h-8 rounded" />
                    <hlm-skeleton class="h-4 flex-1 group-data-[collapsible=icon]:hidden" />
                  </div>
                </li>
              }
            } @else {
              <!-- User Queries (top) -->
              @for (entry of userQueryEntries(); track entry[0]) {
                <li hlmSidebarMenuItem>
                  <app-filing-query-item
                    [guid]="entry[0]"
                    [query]="entry[1]"
                    [isActive]="currentGuid() === entry[0]"
                    [isRenaming]="renamingGuid() === entry[0]"
                    [renameValue]="renameValue()"
                    [color]="getColorForGuid(entry[0])"
                    [iconText]="getTextForSquare(entry[1])"
                    [displayText]="getQueryDisplayText(entry[1])"
                    [relativeTime]="getRelativeTime(entry[1].lastUsed)"
                    (select)="selectSavedQuery($event)"
                    (togglePin)="onTogglePin($event)"
                    (duplicate)="onDuplicateQuery($event)"
                    (rename)="onRenameQuery($event)"
                    (deleteQuery)="onDeleteQuery($event)"
                    (renameKeydown)="onRenameKeydown($event)"
                    (saveRename)="saveRename()"
                    (renameValueChange)="renameValue.set($event)"
                  />
                </li>
              }

              <!-- Blueprint Queries (bottom, slightly different bg) -->
              @if (blueprintQueryEntries().length > 0) {
                <li hlmSidebarMenuItem class="mt-1">
                  <div class="text-[10px] text-[#6e6e6e] uppercase tracking-wide px-2 py-1 group-data-[collapsible=icon]:hidden">Defaults</div>
                </li>
                @for (entry of blueprintQueryEntries(); track entry[0]) {
                  <li hlmSidebarMenuItem>
                    <app-filing-query-item
                      [guid]="entry[0]"
                      [query]="entry[1]"
                      [isActive]="currentGuid() === entry[0]"
                      [isRenaming]="renamingGuid() === entry[0]"
                      [renameValue]="renameValue()"
                      [color]="getColorForGuid(entry[0])"
                      [iconText]="getTextForSquare(entry[1])"
                      [displayText]="getQueryDisplayText(entry[1])"
                      [relativeTime]="getRelativeTime(entry[1].lastUsed)"
                      [isBlueprint]="true"
                      (select)="selectSavedQuery($event)"
                      (togglePin)="onTogglePin($event)"
                      (duplicate)="onDuplicateQuery($event)"
                      (rename)="onRenameQuery($event)"
                      (deleteQuery)="onDeleteQuery($event)"
                      (resetBlueprint)="onResetBlueprint($event)"
                      (renameKeydown)="onRenameKeydown($event)"
                      (saveRename)="saveRename()"
                      (renameValueChange)="renameValue.set($event)"
                    />
                  </li>
                }
              }

              <!-- Empty state -->
              @if (!hasSavedQueries()) {
                <li hlmSidebarMenuItem>
                  <div class="text-center text-[11px] text-[#6e6e6e] mt-4 group-data-[collapsible=icon]:hidden">
                    No saved queries
                  </div>
                </li>
              }
            }
          </ul>
        </div>
      </div>
    </div>

    <div hlmSidebarFooter class="border-t border-[#3c3c3c] bg-[#252526]">
      <div class="text-[10px] text-[#6e6e6e] px-2 py-1.5 group-data-[collapsible=icon]:hidden">
        <kbd class="text-[#858585]">Ctrl+B</kbd> toggle sidebar
      </div>
    </div>
  </hlm-sidebar>


  <!-- Delete Confirmation Dialog -->
  <hlm-dialog [state]="deleteConfirmGuid() ? 'open' : 'closed'" (closed)="cancelDelete()">
    <hlm-dialog-content class="sm:max-w-[400px] bg-[#252526] border-[#3c3c3c]" *brnDialogContent="let ctx">
      <hlm-dialog-header>
        <h3 hlmDialogTitle class="text-[#cccccc]">Delete Query</h3>
        <p hlmDialogDescription class="text-[#858585]">
          Are you sure you want to delete this query? This action cannot be undone.
        </p>
      </hlm-dialog-header>
      <hlm-dialog-footer class="gap-2">
        <button hlmBtn variant="outline" (click)="cancelDelete()" class="border-[#3c3c3c] text-[#cccccc] hover:bg-[#3c3c3c]">
          Cancel
        </button>
        <button hlmBtn variant="destructive" (click)="confirmDelete()" class="bg-[#f48771] hover:bg-[#d9644d]">
          Delete
        </button>
      </hlm-dialog-footer>
    </hlm-dialog-content>
  </hlm-dialog>

  <!-- Main Content -->
  <main hlmSidebarInset class="flex flex-col h-full bg-[#1e1e1e]">
    <!-- Header with trigger and query panel -->
    <header class="flex-none border-b border-[#3c3c3c]">
      <!-- Title Bar -->
      <div class="flex items-center justify-between h-9 px-3 bg-[#252526]">
        <div class="flex items-center gap-2">
          <button hlmSidebarTrigger class="text-[#858585] hover:text-[#cccccc]">
            <ng-icon name="lucidePanelLeft" />
            <span class="sr-only">Toggle Sidebar</span>
          </button>
          <img
            [src]="animatingLogo() ? '/logo-anim.svg?t=' + logoKey() : '/logo.svg'"
            alt="Nullabroke"
            class="h-7 w-7"
          />
          <span class="text-[13px] text-[#cccccc]">{{ titleText() }}</span>
        </div>
        <button
          (click)="toggleQuery()"
          class="flex items-center gap-1 px-2 py-0.5 text-[12px] text-[#858585] hover:text-[#cccccc] hover:bg-[#3c3c3c] rounded"
        >
          {{ queryExpanded() ? 'Collapse' : 'Expand' }}
          <ng-icon
            [name]="queryExpanded() ? 'lucideChevronUp' : 'lucideChevronDown'"
            class="text-[14px]"
          />
        </button>
      </div>

      <!-- Query Panel (collapsible) -->
      @if (queryExpanded()) {
        <app-filing-query-editor
          [queryControl]="queryControl"
          [isQueryValid]="isQueryValid()"
          [parseErrors]="parseErrors()"
          [hasParameters]="hasParameters()"
          (searchTriggered)="search()"
        />
      }

      <!-- Parameter Inputs + Search Button (ALWAYS visible, even when query editor is collapsed) -->
      <app-query-parameters
        [loading]="loading()"
        [searchDisabled]="loading() || !isQueryValid()"
        (searchClick)="search()"
      />
    </header>

    <!-- Results Area -->
    <main class="flex-1 overflow-auto bg-[#1e1e1e]">
      @if (error()) {
        <div class="px-3 py-2 bg-[#5a1d1d] text-[#f48771] text-[13px] border-b border-[#3c3c3c]">
          {{ error() }}
        </div>
      }

      @if (results().length === 0 && !loading() && !hasSearched()) {
        <div class="flex flex-col items-center justify-center h-full text-[#6e6e6e]">
          <ng-icon name="lucideSearch" class="text-[48px] mb-3 opacity-30" />
          <p class="text-[13px]">Enter a query to search SEC filings</p>
          <p class="text-[12px] mt-1 font-mono text-[#4e4e4e]">form_type = '10-K' limit 25</p>
          <p class="text-[11px] mt-3 text-[#4ec9b0]">
            Tip: Use <code class="bg-[#2d2d2d] px-1 rounded">{{ '{' }}Label:Type:Default{{ '}' }}</code> for dynamic parameters
          </p>
        </div>
      }

      @if (results().length === 0 && !loading() && hasSearched()) {
        <div class="flex flex-col items-center justify-center h-full text-[#6e6e6e]">
          <p class="text-[13px]">No filings found</p>
        </div>
      }

      @if (results().length > 0) {
        <!-- Results Header -->
        <div
          class="sticky top-0 flex items-center h-6 px-3 bg-[#252526] border-b border-[#3c3c3c] text-[11px] text-[#858585] uppercase tracking-wide z-10"
        >
          {{ results().length }} results
        </div>

        <!-- Results List -->
        <div class="divide-y divide-[#3c3c3c]" role="list" aria-label="Search results">
          @for (filing of results(); track filing.id) {
            <app-filing-result-row [filing]="filing" />
          }
        </div>
      }
    </main>

    <!-- Status Bar -->
    <app-filing-status-bar
      [loading]="loading()"
      [hasSearched]="hasSearched()"
      [resultCount]="results().length"
    />
  </main>
</div>
